<!DOCTYPE html>  <html> <head>   <title>worker.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="loader.html">                 loader.coffee               </a>                                           <a class="source" href="plug_sockets.html">                 plug_sockets.coffee               </a>                                           <a class="source" href="publish.html">                 publish.coffee               </a>                                           <a class="source" href="session.html">                 session.coffee               </a>                                           <a class="source" href="users_online.html">                 users_online.coffee               </a>                                           <a class="source" href="worker.html">                 worker.coffee               </a>                                           <a class="source" href="wrapper.html">                 wrapper.coffee               </a>                                           <a class="source" href="zmq_async.html">                 zmq_async.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               worker.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <h2>Backend Server Worker</h2>

<p>Runs server-side actions and shared code, returning the result for the website or HTTP API</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">load = </span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./loader.coffee&#39;</span><span class="p">)</span>
<span class="nv">check = </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../utils/check.coffee&#39;</span><span class="p">)</span>

<span class="nv">exports.bannerText = </span><span class="nf">(standalone) -&gt;</span>
  <span class="nv">counters = </span><span class="nx">SS</span><span class="p">.</span><span class="nx">internal</span><span class="p">.</span><span class="nx">counters</span><span class="p">.</span><span class="nx">files_loaded</span>
  <span class="p">[</span><span class="s2">&quot;Back end server loaded #{counters.models.pluralize(&#39;model&#39;)}, #{counters.server} server and #{counters.shared.pluralize(&#39;shared file&#39;)} in #{SS.internal.uptime()}ms&quot;</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Connect any Plug Sockets if ZeroMQ is installed</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">if</span> <span class="nx">SS</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">plug_sockets</span><span class="p">.</span><span class="nx">enabled</span>
  <span class="k">if</span> <span class="nx">SS</span><span class="p">.</span><span class="nx">internal</span><span class="p">.</span><span class="nx">zmq</span>
    <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./plug_sockets.coffee&#39;</span><span class="p">).</span><span class="nx">init</span><span class="p">()</span>
  <span class="k">else</span>
    <span class="nx">SS</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">plug_sockets</span><span class="p">.</span><span class="nx">plugs</span><span class="p">.</span><span class="nx">any</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="nx">SS</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="p">(</span><span class="s1">&#39;Warning: Plug Sockets disabled when running in single process mode. Please install ZeroMQ&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Load any database connections</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">load</span><span class="p">.</span><span class="nx">dbConfigFile</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Load Event Emitter and custom server-side events</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">load</span><span class="p">.</span><span class="nx">serverSideEvents</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Load file 'trees' for each app folder</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">trees = </span><span class="nx">load</span><span class="p">.</span><span class="nx">fileTrees</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Check none of the files and dirs conflict</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">check</span><span class="p">.</span><span class="nx">forNameConflicts</span><span class="p">(</span><span class="nx">trees</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Load application files within /app/shared and /app/server</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">load</span><span class="p">.</span><span class="nx">serverSideFiles</span><span class="p">(</span><span class="nx">trees</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Load Redis. Note these connections stay open so scripts will cease to terminate on their own once you call this</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">if</span> <span class="nx">SS</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">redis</span><span class="p">.</span><span class="nx">enabled</span>
  <span class="nv">SS.redis = </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../redis.coffee&#39;</span><span class="p">).</span><span class="nx">connect</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Load optional Users Online module</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">SS.users.online = </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./users_online.coffee&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="nx">SS</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">users_online</span><span class="p">.</span><span class="nx">enabled</span>
<span class="k">else</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s1">&#39;Note: Redis support is disabled. This MUST be enabled before hosting your app, using the Users Online feature, or running in multi-process mode. See /config/app.coffee&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Load publish API</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">SS.publish = </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./publish.coffee&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Listen for work</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">unless</span> <span class="nx">SS</span><span class="p">.</span><span class="nx">internal</span><span class="p">.</span><span class="nx">mode</span> <span class="o">is</span> <span class="s1">&#39;console&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Load default message responders</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./responders&#39;</span><span class="p">)</span>

  <span class="nv">rpc = </span><span class="k">new</span> <span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../rpc/connection.coffee&#39;</span><span class="p">)).</span><span class="nx">Server</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Listen for incoming requests and dispatch them to a responder</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">rpc</span><span class="p">.</span><span class="nx">listen</span> <span class="nf">(obj, cb) -&gt;</span>
    <span class="k">try</span>      </pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>First argument is the event name which a responder must listen for</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">args = </span><span class="p">[</span><span class="nx">obj</span><span class="p">.</span><span class="nx">responder</span><span class="p">,</span> <span class="nx">obj</span><span class="p">]</span>
      </pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>If the request has an 'id' field it expects a callback (most system commands such as heartbeats do not)</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">obj</span><span class="p">.</span><span class="nx">id</span><span class="o">?</span> <span class="o">&amp;&amp;</span> <span class="nx">args</span><span class="p">.</span><span class="nx">push</span> <span class="nx">cb</span>
      </pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Emit the request to one or more responders</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">SS</span><span class="p">.</span><span class="nx">backend</span><span class="p">.</span><span class="nx">responders</span><span class="p">.</span><span class="nx">emit</span><span class="p">.</span><span class="nx">apply</span> <span class="nx">SS</span><span class="p">.</span><span class="nx">backend</span><span class="p">.</span><span class="nx">responders</span><span class="p">,</span> <span class="nx">args</span>
    <span class="k">catch</span> <span class="nx">e</span>
      <span class="nx">SS</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">exception</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 