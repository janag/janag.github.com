<!DOCTYPE html>  <html> <head>   <title>publish.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="loader.html">                 loader.coffee               </a>                                           <a class="source" href="plug_sockets.html">                 plug_sockets.coffee               </a>                                           <a class="source" href="publish.html">                 publish.coffee               </a>                                           <a class="source" href="session.html">                 session.coffee               </a>                                           <a class="source" href="users_online.html">                 users_online.coffee               </a>                                           <a class="source" href="worker.html">                 worker.coffee               </a>                                           <a class="source" href="wrapper.html">                 wrapper.coffee               </a>                                           <a class="source" href="zmq_async.html">                 zmq_async.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               publish.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <h2>Publish</h2>

<p>Publishes messages to other clients/users via Redis to be sent upstream to frontend servers (via the router)</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Shall we send events to Redis or direct to the internal EventEmitter as an RPC request?</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">publish_method = </span><span class="nx">SS</span><span class="p">.</span><span class="nx">redis</span> <span class="o">&amp;&amp;</span> <span class="s1">&#39;redis&#39;</span> <span class="o">||</span> <span class="s1">&#39;internal&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>If we're not using the Redis proxy, create the RPC publisher here</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">rpc = </span><span class="k">new</span> <span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../rpc/connection.coffee&#39;</span><span class="p">)).</span><span class="nx">Publisher</span> <span class="nx">unless</span> <span class="nx">SS</span><span class="p">.</span><span class="nx">redis</span>

<span class="nv">module.exports =</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Publish event to every client connected to every server</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">broadcast: </span><span class="nf">(event, params) -&gt;</span> 
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Event Name (first argument) must be a string&#39;</span><span class="p">)</span> <span class="nx">unless</span> <span class="k">typeof</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;string&#39;</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Params (second argument) must be provided (even if just an empty string or object)&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="k">typeof</span><span class="p">(</span><span class="nx">params</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;undefined&#39;</span>
    <span class="nx">SS</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">outgoing</span><span class="p">.</span><span class="nx">event</span> <span class="s2">&quot;Broadcast&quot;</span><span class="p">,</span> <span class="nx">event</span><span class="p">,</span> <span class="nx">params</span>
    <span class="nx">send</span> <span class="s1">&#39;broadcast&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nv">event: </span><span class="nx">event</span><span class="p">,</span> <span class="nv">params: </span><span class="nx">params</span><span class="p">}</span>
  </pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Publish to private channel (users can subscribe/unsubscribe to channels at anytime - see session code)</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">channels: </span><span class="nf">(channels, event, params) -&gt;</span>
    <span class="nx">sendMultiple</span> <span class="s1">&#39;Channels&#39;</span><span class="p">,</span> <span class="nx">channels</span><span class="p">,</span> <span class="nx">event</span><span class="p">,</span> <span class="nx">params</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Alias Channels</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">channel: </span><span class="nf">(channels, event, params) -&gt;</span>
    <span class="nx">@channels</span><span class="p">(</span><span class="nx">channels</span><span class="p">,</span> <span class="nx">event</span><span class="p">,</span> <span class="nx">params</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Publish event to array of user ids</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">users: </span><span class="nf">(users, event, params) -&gt;</span>
    <span class="nx">sendMultiple</span> <span class="s1">&#39;Users&#39;</span><span class="p">,</span> <span class="nx">users</span><span class="p">,</span> <span class="nx">event</span><span class="p">,</span> <span class="nx">params</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Alias Users</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">user: </span><span class="nf">(users, event, params) -&gt;</span>
    <span class="nx">@users</span><span class="p">(</span><span class="nx">users</span><span class="p">,</span> <span class="nx">event</span><span class="p">,</span> <span class="nx">params</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Publish event to array of socket ids</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">sockets: </span><span class="nf">(sockets, event, params) -&gt;</span>
    <span class="nx">sendMultiple</span> <span class="s1">&#39;Sockets&#39;</span><span class="p">,</span> <span class="nx">sockets</span><span class="p">,</span> <span class="nx">event</span><span class="p">,</span> <span class="nx">params</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Alias Sockets</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">socket: </span><span class="nf">(sockets, event, params) -&gt;</span>
    <span class="nx">@sockets</span><span class="p">(</span><span class="nx">sockets</span><span class="p">,</span> <span class="nx">event</span><span class="p">,</span> <span class="nx">params</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Private</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Serialize a message and publish via the correct method</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">send = </span><span class="nf">(msg_type, message) -&gt;</span>
  <span class="nv">msg = </span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span>
  <span class="nx">publishers</span><span class="p">[</span><span class="nx">publish_method</span><span class="p">](</span><span class="nx">msg_type</span><span class="p">,</span> <span class="nx">msg</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Send a message to one or more destinations via Redis
As this is a back end server it has no knowledge of websockets and must not publish
directly to websockets (even though you are able in single-process mode)</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">sendMultiple = </span><span class="nf">(name, destinations, event, params = null) -&gt;</span>
  <span class="nv">destinations = </span><span class="p">[</span><span class="nx">destinations</span><span class="p">]</span> <span class="nx">unless</span> <span class="k">typeof</span><span class="p">(</span><span class="nx">destinations</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;object&#39;</span>
  <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;No #{name} specified (first argument)&quot;</span><span class="p">)</span> <span class="nx">unless</span> <span class="nx">destinations</span> <span class="o">&amp;&amp;</span> <span class="nx">destinations</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
  <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Event Name (second argument) must be a string&#39;</span><span class="p">)</span> <span class="nx">unless</span> <span class="k">typeof</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;string&#39;</span>
  <span class="nx">SS</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">outgoing</span><span class="p">.</span><span class="nx">event</span> <span class="s2">&quot;#{name} [#{destinations.join(&#39;, &#39;)}]&quot;</span><span class="p">,</span> <span class="nx">event</span><span class="p">,</span> <span class="nx">params</span>
  <span class="nx">send</span> <span class="nx">name</span><span class="p">,</span> <span class="p">{</span><span class="nv">event: </span><span class="nx">event</span><span class="p">,</span> <span class="nv">params: </span><span class="nx">params</span><span class="p">,</span> <span class="nv">destinations: </span><span class="nx">destinations</span><span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <h2>Publish Methods</h2>

<p>Either send directly through RPC Publisher connection, or proxy through Redis for better scalability</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">publishers = </span>

  <span class="nv">redis: </span><span class="nf">(msg_type, message) -&gt;</span>
    <span class="nv">redis_channel = </span><span class="s2">&quot;#{SS.config.redis.key_prefix}:#{msg_type.toLowerCase()}&quot;</span>
    <span class="nx">SS</span><span class="p">.</span><span class="nx">redis</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">publish</span> <span class="nx">redis_channel</span><span class="p">,</span> <span class="nx">message</span>
  
  <span class="nv">internal: </span><span class="nf">(msg_type, message) -&gt;</span>
    <span class="nx">rpc</span><span class="p">.</span><span class="nx">send</span> <span class="nx">msg_type</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">(),</span> <span class="nx">message</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 