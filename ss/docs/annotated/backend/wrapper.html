<!DOCTYPE html>  <html> <head>   <title>wrapper.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="loader.html">                 loader.coffee               </a>                                           <a class="source" href="plug_sockets.html">                 plug_sockets.coffee               </a>                                           <a class="source" href="publish.html">                 publish.coffee               </a>                                           <a class="source" href="session.html">                 session.coffee               </a>                                           <a class="source" href="users_online.html">                 users_online.coffee               </a>                                           <a class="source" href="worker.html">                 worker.coffee               </a>                                           <a class="source" href="wrapper.html">                 wrapper.coffee               </a>                                           <a class="source" href="zmq_async.html">                 zmq_async.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               wrapper.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <h2>Backend Worker - Process Wrapper</h2>

<p>Manages back end worker processes which respond to incoming requests, restarting them if required</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">fs = </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">)</span>
<span class="nv">spawn = </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;child_process&#39;</span><span class="p">).</span><span class="nx">spawn</span>

<span class="nv">file_utils = </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../utils/file.js&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Store worker processes here</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">_workers = </span><span class="p">[]</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Declare variable in module scope</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">num_workers = </span><span class="mi">1</span>

<span class="nv">exports.bannerText = </span><span class="nf">(standalone) -&gt;</span>
  <span class="nv">counters = </span><span class="nx">SS</span><span class="p">.</span><span class="nx">internal</span><span class="p">.</span><span class="nx">counters</span><span class="p">.</span><span class="nx">files_loaded</span>
  <span class="nv">text = </span><span class="p">[]</span>
  <span class="nx">text</span><span class="p">.</span><span class="nx">push</span> <span class="s2">&quot;Back end server connecting to #{SS.config.cluster.sockets.be_main}&quot;</span> <span class="k">if</span> <span class="nx">standalone</span>
  <span class="nx">text</span><span class="p">.</span><span class="nx">push</span> <span class="s2">&quot;Spawned #{num_workers} back end worker #{if num_workers == 1 then &#39;process&#39; else &#39;processes&#39;} (PID #{(_workers.map (worker) -&gt; worker.pid).join(&#39;, &#39;)})&quot;</span>
  <span class="nx">SS</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">plug_sockets</span><span class="p">.</span><span class="nx">enabled</span> <span class="o">&amp;&amp;</span> <span class="nx">text</span><span class="p">.</span><span class="nx">push</span> <span class="s2">&quot;Plug Sockets: Binding SS.plugs.#{name} to #{details.connect_to}&quot;</span> <span class="k">for</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">details</span> <span class="k">of</span> <span class="nx">SS</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">plug_sockets</span><span class="p">.</span><span class="nx">plugs</span>
  <span class="nx">text</span>


<span class="nv">exports.init = </span><span class="nf">(args) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Number of worker processes to start</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">num_workers = </span><span class="k">if</span> <span class="nx">args</span> <span class="k">then</span> <span class="p">(</span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="s1">&#39;-w&#39;</span><span class="p">])</span> <span class="o">||</span> <span class="mi">2</span><span class="p">)</span> <span class="k">else</span> <span class="mi">1</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Start worker processes</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">startWorker</span><span class="p">()</span> <span class="k">for</span> <span class="nx">num</span> <span class="k">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">..</span><span class="nx">num_workers</span><span class="p">]</span>
  </pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Watch files for changes</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">watchForChanges</span><span class="p">()</span> <span class="k">if</span> <span class="nx">SS</span><span class="p">.</span><span class="nx">env</span> <span class="o">==</span> <span class="s1">&#39;development&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>PRIVATE</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">startWorker = </span><span class="o">-&gt;</span>

  <span class="nv">worker = </span><span class="nx">spawn</span><span class="p">(</span><span class="s1">&#39;socketstream&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;backend-worker&#39;</span><span class="p">])</span>

  <span class="nx">worker</span><span class="p">.</span><span class="nx">stdout</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="nf">(data) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Would be nice to find a better way to prevent two line breaks</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="nx">data</span><span class="p">.</span><span class="nx">toString</span><span class="p">().</span><span class="nx">replace</span><span class="p">(</span><span class="s2">&quot;\n&quot;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

  <span class="nx">worker</span><span class="p">.</span><span class="nx">stderr</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="nf">(data) -&gt;</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="nx">data</span><span class="p">.</span><span class="nx">toString</span><span class="p">().</span><span class="nx">replace</span><span class="p">(</span><span class="s2">&quot;\n&quot;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

  <span class="nx">worker</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;exit&#39;</span><span class="p">,</span> <span class="nf">(code, signal) -&gt;</span>
    <span class="nx">startWorker</span><span class="p">()</span> <span class="nx">unless</span> <span class="nx">code</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">and</span> <span class="nx">SS</span><span class="p">.</span><span class="nx">env</span> <span class="o">==</span> <span class="s1">&#39;development&#39;</span>
  
  <span class="nx">_workers</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">worker</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Kill worker process if any files change (manager will re-spawn)</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">watchForChanges = </span><span class="o">-&gt;</span>
  <span class="nv">dirs = </span><span class="p">[</span><span class="s1">&#39;/app/server&#39;</span><span class="p">,</span> <span class="s1">&#39;/app/models&#39;</span><span class="p">,</span> <span class="s1">&#39;/app/shared&#39;</span><span class="p">,</span> <span class="s1">&#39;/config&#39;</span><span class="p">,</span> <span class="s1">&#39;/lib/server&#39;</span><span class="p">]</span>
  <span class="nx">dirs</span><span class="p">.</span><span class="nx">forEach</span> <span class="nf">(dir) -&gt;</span>
    <span class="nv">tree = </span><span class="nx">file_utils</span><span class="p">.</span><span class="nx">readDirSync</span><span class="p">(</span><span class="nx">SS</span><span class="p">.</span><span class="nx">root</span> <span class="o">+</span> <span class="nx">dir</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">tree</span><span class="p">.</span><span class="nx">files</span>
      <span class="nx">tree</span><span class="p">.</span><span class="nx">files</span><span class="p">.</span><span class="nx">forEach</span> <span class="nf">(path) -&gt;</span>
        <span class="nx">fs</span><span class="p">.</span><span class="nx">watchFile</span> <span class="nx">path</span><span class="p">,</span> <span class="nf">(curr, prev) -&gt;</span>
          <span class="k">if</span> <span class="o">!</span><span class="nx">curr</span> <span class="o">or</span> <span class="p">(</span><span class="nb">Number</span><span class="p">(</span><span class="nx">curr</span><span class="p">.</span><span class="nx">mtime</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">prev</span><span class="p">.</span><span class="nx">mtime</span><span class="p">))</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;Change detected in #{path}. Restarting back end workers...&quot;</span>
            <span class="nx">_workers</span><span class="p">.</span><span class="nx">forEach</span> <span class="nf">(worker) -&gt;</span> <span class="nx">worker</span><span class="p">.</span><span class="nx">kill</span> <span class="s1">&#39;SIGHUP&#39;</span>            </pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Note: this only works when you're running the integrated 'socketstream server' as you typically would in development
It should really be fired once the worker has reloaded. Will improve in the future</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">SS</span><span class="p">.</span><span class="nx">io</span><span class="p">.</span><span class="nx">sockets</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;reload&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="nx">SS</span><span class="p">.</span><span class="nx">io</span> 

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 