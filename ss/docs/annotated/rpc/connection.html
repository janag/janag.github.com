<!DOCTYPE html>  <html> <head>   <title>connection.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="connection.html">                 connection.coffee               </a>                                           <a class="source" href="internal.html">                 internal.coffee               </a>                                           <a class="source" href="serializer.html">                 serializer.coffee               </a>                                           <a class="source" href="zeromq.html">                 zeromq.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               connection.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <h2>Internal RPC Connection</h2>

<p>Very simple wrapper to provide asynchronous RPC requests with callbacks. Can utilize multiple transports (ZeroMQ or internal EventEmitters)
Incoming replies are matched with outgoing requests via the message 'id' which must be passed through from the Server to Client
Inspired by http://groups.google.com/group/json-rpc/web/json-rpc-2-0 but documented in /doc/guide/rpc_spec.md</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">Connection</span>

  <span class="nv">constructor: </span><span class="o">-&gt;</span>
    <span class="vi">@transport_type = </span><span class="nx">detectTransport</span><span class="p">()</span>
    <span class="vi">@transport_klass = </span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;./transports/#{@transport_type}.coffee&quot;</span><span class="p">)</span>
    <span class="vi">@debug = </span><span class="kc">false</span>


<span class="k">class</span> <span class="nx">exports</span><span class="p">.</span><span class="nx">Client</span> <span class="k">extends</span> <span class="nx">Connection</span>

  <span class="nv">constructor: </span><span class="nf">(@name = &#39;default&#39;) -&gt;</span>
    <span class="k">super</span><span class="p">()</span>
    <span class="vi">@transport = </span><span class="k">new</span> <span class="nx">@transport_klass</span><span class="p">.</span><span class="nx">Client</span>
    <span class="nx">@transport</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">@name</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Each client gets it's own request numbers and callback stack</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@request_num = </span><span class="mi">0</span>
    <span class="vi">@stack = </span><span class="p">{}</span>
    </pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Listen for incoming responses</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@transport</span><span class="p">.</span><span class="nx">listen</span> <span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="o">=&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Output message for debugging</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">@debug</span> <span class="o">&amp;&amp;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;RPC Client: Msg in via #{@transport_type} transport:&quot;</span><span class="p">,</span> <span class="nx">obj</span><span class="p">)</span>
  </pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>All messages in MUST include an ID field containing the same number contained in the request</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">id</span>
        <span class="nx">@stack</span><span class="p">[</span><span class="nx">obj</span><span class="p">.</span><span class="nx">id</span><span class="p">](</span><span class="nx">obj</span><span class="p">)</span>
        <span class="k">delete</span> <span class="nx">@stack</span><span class="p">[</span><span class="nx">obj</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span>
      <span class="k">else</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Invalid RPC async response. An &#39;id&#39; field must be provided&quot;</span><span class="p">)</span>

  <span class="nv">send: </span><span class="nf">(obj, cb) -&gt;</span>

    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Message to RPC client must be an object&#39;</span><span class="p">)</span> <span class="nx">unless</span> <span class="k">typeof</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;object&#39;</span>
    </pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Callbacks are optional. Sometimes you just want to send a command and not care about a response</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">cb</span> 
      <span class="nv">obj.id = </span><span class="o">++</span><span class="nx">@request_num</span>
      <span class="nx">@stack</span><span class="p">[</span><span class="nx">obj</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">cb</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Append version number and client name</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">obj.version = </span><span class="nx">SS</span><span class="p">.</span><span class="nx">internal</span><span class="p">.</span><span class="nx">rpc</span><span class="p">.</span><span class="nx">version</span>
    <span class="nv">obj.origin = </span><span class="nx">@name</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Output message for debugging</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@debug</span> <span class="o">&amp;&amp;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;RPC Client: Msg to be sent via #{@transport_type} transport:&quot;</span><span class="p">,</span> <span class="nx">obj</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Send to back end</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@transport</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Return original message object sent</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">obj</span>


<span class="k">class</span> <span class="nx">exports</span><span class="p">.</span><span class="nx">Server</span> <span class="k">extends</span> <span class="nx">Connection</span>

  <span class="nv">constructor: </span><span class="o">-&gt;</span>
    <span class="k">super</span><span class="p">()</span>
    <span class="vi">@transport = </span><span class="k">new</span> <span class="nx">@transport_klass</span><span class="p">.</span><span class="nx">Server</span>
    <span class="nx">@transport</span><span class="p">.</span><span class="nx">connect</span><span class="p">()</span>
  
  <span class="nv">listen: </span><span class="nf">(cb) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Listen for incoming requests</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@transport</span><span class="p">.</span><span class="nx">listen</span> <span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">transport_cb</span><span class="p">)</span> <span class="o">=&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Silently drop any messages confirming to another RPC version (allows staggered upgrades)</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">return</span> <span class="kc">false</span> <span class="nx">unless</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">version</span> <span class="o">==</span> <span class="nx">SS</span><span class="p">.</span><span class="nx">internal</span><span class="p">.</span><span class="nx">rpc</span><span class="p">.</span><span class="nx">version</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Output message for debugging</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">@debug</span> <span class="o">&amp;&amp;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;RPC Server: Msg in via #{@transport_type}:&quot;</span><span class="p">,</span> <span class="nx">obj</span><span class="p">)</span>

      <span class="nx">cb</span> <span class="nx">obj</span><span class="p">,</span> <span class="nx">transport_cb</span>


<span class="k">class</span> <span class="nx">exports</span><span class="p">.</span><span class="nx">Publisher</span> <span class="k">extends</span> <span class="nx">Connection</span>

  <span class="nv">constructor: </span><span class="o">-&gt;</span>
    <span class="k">super</span><span class="p">()</span>
    <span class="vi">@transport = </span><span class="k">new</span> <span class="nx">@transport_klass</span><span class="p">.</span><span class="nx">Publisher</span>
    <span class="nx">@transport</span><span class="p">.</span><span class="nx">connect</span><span class="p">()</span>

  <span class="nv">send: </span><span class="nf">(message_type, message) -&gt;</span>
    <span class="nx">@transport</span><span class="p">.</span><span class="nx">send</span> <span class="nx">message_type</span><span class="p">,</span> <span class="nx">message</span>


<span class="k">class</span> <span class="nx">exports</span><span class="p">.</span><span class="nx">Subscriber</span> <span class="k">extends</span> <span class="nx">Connection</span>

  <span class="nv">constructor: </span><span class="o">-&gt;</span>
    <span class="k">super</span><span class="p">()</span>
    <span class="vi">@transport = </span><span class="k">new</span> <span class="nx">@transport_klass</span><span class="p">.</span><span class="nx">Subscriber</span>
    <span class="nx">@transport</span><span class="p">.</span><span class="nx">connect</span><span class="p">()</span>

  <span class="nv">listen: </span><span class="nf">(cb) -&gt;</span>
    <span class="nx">@transport</span><span class="p">.</span><span class="nx">listen</span> <span class="nx">cb</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>PRIVATE</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>If ZeroMQ is present, use it, else fallback on the internal EventEmitter
In the near future we will support the child_process JSON API in Node 0.5</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">detectTransport = </span><span class="o">-&gt;</span>
  <span class="nx">SS</span><span class="p">.</span><span class="nx">internal</span><span class="p">.</span><span class="nx">zmq</span> <span class="o">&amp;&amp;</span> <span class="s1">&#39;zeromq&#39;</span> <span class="o">||</span> <span class="s1">&#39;internal&#39;</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 