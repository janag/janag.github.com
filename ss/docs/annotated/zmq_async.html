<!DOCTYPE html>  <html> <head>   <title>zmq_async.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="api.html">                 api.coffee               </a>                                           <a class="source" href="benchmark.html">                 benchmark.coffee               </a>                                           <a class="source" href="benchmarks.html">                 benchmarks.coffee               </a>                                           <a class="source" href="browser_check.html">                 browser_check.coffee               </a>                                           <a class="source" href="check.html">                 check.coffee               </a>                                           <a class="source" href="client.html">                 client.coffee               </a>                                           <a class="source" href="compile.html">                 compile.coffee               </a>                                           <a class="source" href="connection.html">                 connection.coffee               </a>                                           <a class="source" href="copy.html">                 copy.coffee               </a>                                           <a class="source" href="default.html">                 default.coffee               </a>                                           <a class="source" href="generator.html">                 generator.coffee               </a>                                           <a class="source" href="http_redirect.html">                 http_redirect.coffee               </a>                                           <a class="source" href="https_redirect.html">                 https_redirect.coffee               </a>                                           <a class="source" href="index.html">                 index.coffee               </a>                                           <a class="source" href="internal.html">                 internal.coffee               </a>                                           <a class="source" href="job_scheduler.html">                 job_scheduler.coffee               </a>                                           <a class="source" href="loader.html">                 loader.coffee               </a>                                           <a class="source" href="logger.html">                 logger.coffee               </a>                                           <a class="source" href="main.html">                 main.coffee               </a>                                           <a class="source" href="manager.html">                 manager.coffee               </a>                                           <a class="source" href="mongoose.html">                 mongoose.coffee               </a>                                           <a class="source" href="pack.html">                 pack.coffee               </a>                                           <a class="source" href="parse_url.html">                 parse_url.coffee               </a>                                           <a class="source" href="plug_sockets.html">                 plug_sockets.coffee               </a>                                           <a class="source" href="publish.html">                 publish.coffee               </a>                                           <a class="source" href="rate_limiter.html">                 rate_limiter.coffee               </a>                                           <a class="source" href="redis.html">                 redis.coffee               </a>                                           <a class="source" href="redis_proxy.html">                 redis_proxy.coffee               </a>                                           <a class="source" href="rest.html">                 rest.coffee               </a>                                           <a class="source" href="rtm.html">                 rtm.coffee               </a>                                           <a class="source" href="serializer.html">                 serializer.coffee               </a>                                           <a class="source" href="server.html">                 server.coffee               </a>                                           <a class="source" href="session.html">                 session.coffee               </a>                                           <a class="source" href="socket.html">                 socket.coffee               </a>                                           <a class="source" href="socketstream.html">                 socketstream.coffee               </a>                                           <a class="source" href="ssl.html">                 ssl.coffee               </a>                                           <a class="source" href="subscribe.html">                 subscribe.coffee               </a>                                           <a class="source" href="system.html">                 system.coffee               </a>                                           <a class="source" href="templates.html">                 templates.coffee               </a>                                           <a class="source" href="users_online.html">                 users_online.coffee               </a>                                           <a class="source" href="utils.html">                 utils.coffee               </a>                                           <a class="source" href="worker.html">                 worker.coffee               </a>                                           <a class="source" href="wrapper.html">                 wrapper.coffee               </a>                                           <a class="source" href="zeromq.html">                 zeromq.coffee               </a>                                           <a class="source" href="zmq_async.html">                 zmq_async.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               zmq_async.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <h2>ZeroMQ Async Request</h2>

<p>Very simple wrapper around the standard ZMQ library to provide asynchronous RPC requests with callbacks
Incoming replies are matched with outgoing requests via the message 'id' which must be passed through
as suggested by http://groups.google.com/group/json-rpc/web/json-rpc-2-0</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>msgpack = require('msgpack-0.4')  (Note: I tried this but it made negligible difference, in some cases slower than JSON!)</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">exports</span><span class="p">.</span><span class="nx">Socket</span>

  <span class="nv">constructor: </span><span class="nf">(@socket_type = &#39;xreq&#39;, @connect_to = SS.config.cluster.sockets.fe_main, @format = SS.config.cluster.serialization) -&gt;</span>
    <span class="vi">@socket = </span><span class="nx">SS</span><span class="p">.</span><span class="nx">internal</span><span class="p">.</span><span class="nx">zmq</span><span class="p">.</span><span class="nx">createSocket</span><span class="p">(</span><span class="nx">@socket_type</span><span class="p">)</span>
    <span class="nx">@socket</span><span class="p">.</span><span class="nx">connect</span> <span class="nx">@connect_to</span>
        
    <span class="vi">@request_num = </span><span class="mi">0</span>
    <span class="vi">@stack = </span><span class="p">{}</span>
    <span class="vi">@debug = </span><span class="kc">false</span>
  </pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Listen for incoming responses</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@socket</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Attempt to parse message</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">try</span>
        <span class="nv">obj = </span><span class="nx">exports</span><span class="p">.</span><span class="nx">formats</span><span class="p">[</span><span class="nx">@format</span><span class="p">].</span><span class="nx">unpack</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;ZeroMQ socket received:&#39;</span><span class="p">,</span> <span class="nx">obj</span><span class="p">)</span> <span class="k">if</span> <span class="nx">@debug</span>
      <span class="k">catch</span> <span class="nx">e</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Invalid ZeroMQ async message received. Unable to parse #{@format} message. Reason given: #{e.message}&quot;</span><span class="p">)</span>
  </pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>All messages in MUST include an ID field containing the same number contained in the request</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">id</span>
        <span class="nx">@stack</span><span class="p">[</span><span class="nx">obj</span><span class="p">.</span><span class="nx">id</span><span class="p">](</span><span class="nx">obj</span><span class="p">)</span>
        <span class="k">delete</span> <span class="nx">@stack</span><span class="p">[</span><span class="nx">obj</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span>
      <span class="k">else</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Invalid ZeroMQ async response. An &#39;id&#39; field must be provided&quot;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>First argument must be the message object - e.g. {method: 'sum', params: [4,1,5]}
Second argument is optional. It can be an object or array. Use it as a place to store associated data with the request that won't be sent over the wired (e.g. the socket we need to emit the response to)
Final argument must be the callback which is also optional (sometimes we just want to send a command and not care about a response)</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">send: </span><span class="nf">() -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Ugly but fast. Improvements welcome. Remember store and cb are both optional</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="p">[</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">cb</span><span class="p">]</span> <span class="o">=</span> <span class="nx">arguments</span>
    
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Message to ZeroMQ async wrapper must be an object&#39;</span><span class="p">)</span> <span class="nx">unless</span> <span class="k">typeof</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;object&#39;</span>
    </pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Callbacks are optional. Sometimes you just want to send a command and not care about a response</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">cb</span> 
      <span class="nv">obj.id = </span><span class="o">++</span><span class="nx">@request_num</span>
      <span class="nx">@stack</span><span class="p">[</span><span class="nx">obj</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">cb</span>

    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;ZeroMQ socket about to serialize message object:&#39;</span><span class="p">,</span> <span class="nx">obj</span><span class="p">)</span> <span class="k">if</span> <span class="nx">@debug</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Pack and send</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">msg = </span><span class="nx">exports</span><span class="p">.</span><span class="nx">formats</span><span class="p">[</span><span class="nx">@format</span><span class="p">].</span><span class="nx">pack</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span>
    <span class="nx">@socket</span><span class="p">.</span><span class="nx">send</span> <span class="nx">msg</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Return original message object sent</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">obj</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Serialization formats supported</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">exports.formats =</span>

  <span class="nv">json:</span>
    <span class="nv">pack: </span><span class="nf">(obj) -&gt;</span>
      <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span>
    <span class="nv">unpack: </span><span class="nf">(msg) -&gt;</span>
      <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">toString</span><span class="p">())</span>
  
  <span class="nv">msgpack: </span>  
    <span class="nv">pack: </span><span class="nf">(obj) -&gt;</span>
      <span class="nx">msgpack</span><span class="p">.</span><span class="nx">pack</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span>
    <span class="nv">unpack: </span><span class="nf">(msg) -&gt;</span>
      <span class="nx">msgpack</span><span class="p">.</span><span class="nx">unpack</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 