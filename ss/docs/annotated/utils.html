<!DOCTYPE html>  <html> <head>   <title>utils.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="api.html">                 api.coffee               </a>                                           <a class="source" href="benchmark.html">                 benchmark.coffee               </a>                                           <a class="source" href="benchmarks.html">                 benchmarks.coffee               </a>                                           <a class="source" href="browser_check.html">                 browser_check.coffee               </a>                                           <a class="source" href="check.html">                 check.coffee               </a>                                           <a class="source" href="client.html">                 client.coffee               </a>                                           <a class="source" href="compile.html">                 compile.coffee               </a>                                           <a class="source" href="connection.html">                 connection.coffee               </a>                                           <a class="source" href="copy.html">                 copy.coffee               </a>                                           <a class="source" href="default.html">                 default.coffee               </a>                                           <a class="source" href="generator.html">                 generator.coffee               </a>                                           <a class="source" href="http_redirect.html">                 http_redirect.coffee               </a>                                           <a class="source" href="https_redirect.html">                 https_redirect.coffee               </a>                                           <a class="source" href="index.html">                 index.coffee               </a>                                           <a class="source" href="internal.html">                 internal.coffee               </a>                                           <a class="source" href="job_scheduler.html">                 job_scheduler.coffee               </a>                                           <a class="source" href="loader.html">                 loader.coffee               </a>                                           <a class="source" href="logger.html">                 logger.coffee               </a>                                           <a class="source" href="main.html">                 main.coffee               </a>                                           <a class="source" href="manager.html">                 manager.coffee               </a>                                           <a class="source" href="mongoose.html">                 mongoose.coffee               </a>                                           <a class="source" href="pack.html">                 pack.coffee               </a>                                           <a class="source" href="parse_url.html">                 parse_url.coffee               </a>                                           <a class="source" href="plug_sockets.html">                 plug_sockets.coffee               </a>                                           <a class="source" href="publish.html">                 publish.coffee               </a>                                           <a class="source" href="rate_limiter.html">                 rate_limiter.coffee               </a>                                           <a class="source" href="redis.html">                 redis.coffee               </a>                                           <a class="source" href="redis_proxy.html">                 redis_proxy.coffee               </a>                                           <a class="source" href="rest.html">                 rest.coffee               </a>                                           <a class="source" href="rtm.html">                 rtm.coffee               </a>                                           <a class="source" href="serializer.html">                 serializer.coffee               </a>                                           <a class="source" href="server.html">                 server.coffee               </a>                                           <a class="source" href="session.html">                 session.coffee               </a>                                           <a class="source" href="socket.html">                 socket.coffee               </a>                                           <a class="source" href="socketstream.html">                 socketstream.coffee               </a>                                           <a class="source" href="ssl.html">                 ssl.coffee               </a>                                           <a class="source" href="subscribe.html">                 subscribe.coffee               </a>                                           <a class="source" href="system.html">                 system.coffee               </a>                                           <a class="source" href="templates.html">                 templates.coffee               </a>                                           <a class="source" href="users_online.html">                 users_online.coffee               </a>                                           <a class="source" href="utils.html">                 utils.coffee               </a>                                           <a class="source" href="worker.html">                 worker.coffee               </a>                                           <a class="source" href="wrapper.html">                 wrapper.coffee               </a>                                           <a class="source" href="zeromq.html">                 zeromq.coffee               </a>                                           <a class="source" href="zmq_async.html">                 zmq_async.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               utils.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>Assets Util Helpers</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">fs = </span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;fs&quot;</span><span class="p">)</span>
<span class="nv">util = </span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;util&quot;</span><span class="p">)</span>
<span class="nv">coffee = </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;coffee-script&#39;</span><span class="p">)</span>
<span class="nv">uglifyjs = </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;uglify-js&#39;</span><span class="p">)</span>

<span class="nv">exports.fileList = </span><span class="nf">(path, first_file = null) -&gt;</span>
  <span class="k">try</span>
    <span class="nv">files = </span><span class="nx">fs</span><span class="p">.</span><span class="nx">readdirSync</span><span class="p">(</span><span class="nx">path</span><span class="p">).</span><span class="nx">filter</span><span class="p">(</span><span class="nf">(file) -&gt;</span> <span class="o">!</span><span class="nx">file</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/(^_|^\.)/</span><span class="p">)).</span><span class="nx">sort</span><span class="p">()</span>
    <span class="k">if</span> <span class="nx">first_file</span> <span class="o">and</span> <span class="nx">files</span><span class="p">.</span><span class="nx">include</span><span class="p">(</span><span class="nx">first_file</span><span class="p">)</span>
      <span class="nv">files = </span><span class="nx">files</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="nx">first_file</span><span class="p">)</span>
      <span class="nx">files</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span><span class="nx">first_file</span><span class="p">)</span> 
    <span class="nx">files</span>
  <span class="k">catch</span> <span class="nx">e</span>
    <span class="k">throw</span> <span class="nx">e</span> <span class="nx">unless</span> <span class="nx">e</span><span class="p">.</span><span class="nx">code</span> <span class="o">==</span> <span class="s1">&#39;ENOENT&#39;</span> <span class="c1"># dir missing</span>
    <span class="p">[]</span>

<span class="nv">exports.concatFiles = </span><span class="nf">(path) -&gt;</span>
  <span class="nv">files = </span><span class="nx">@fileList</span> <span class="nx">path</span>
  <span class="nx">files</span><span class="p">.</span><span class="nx">map</span> <span class="nf">(file_name) -&gt;</span>
    <span class="nx">util</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;  Concatenating file #{file_name}&quot;</span>
    <span class="nv">output = </span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="s2">&quot;#{path}/#{file_name}&quot;</span><span class="p">,</span> <span class="s1">&#39;utf8&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">file_name</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/\.coffee$/i</span><span class="p">)</span>
      <span class="nx">util</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;  Compiling #{file_name} into JS...&quot;</span>
      <span class="k">try</span>
        <span class="nv">output = </span><span class="nx">coffee</span><span class="p">.</span><span class="nx">compile</span><span class="p">(</span><span class="nx">output</span><span class="p">)</span> 
      <span class="k">catch</span> <span class="nx">e</span>
        <span class="nx">util</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;\x1B[1;31mError: Unable to compile CoffeeScript file #{path} to JS\x1B[0m&quot;</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> 
    <span class="nv">output = </span><span class="nx">exports</span><span class="p">.</span><span class="nx">minifyJS</span><span class="p">(</span><span class="nx">file_name</span><span class="p">,</span> <span class="nx">output</span><span class="p">)</span> <span class="k">if</span> <span class="nx">file_name</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/\.(coffee|js)/</span><span class="p">)</span> <span class="o">and</span> <span class="o">!</span><span class="nx">file_name</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/\.min/</span><span class="p">)</span>
    <span class="nx">output</span> <span class="o">+=</span> <span class="s1">&#39;;&#39;</span> <span class="c1"># Ensures the file ends with a semicolon. Many libs don&#39;t and would otherwise break when concatenated</span>
    <span class="nx">output</span>
  <span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;\n&quot;</span><span class="p">)</span>

<span class="nv">exports.minifyJS = </span><span class="nf">(file_name, orig_code) -&gt;</span>
  <span class="nv">formatKb = </span><span class="nf">(size) -&gt;</span> <span class="s2">&quot;#{Math.round(size * 1000) / 1000} KB&quot;</span>
  <span class="nv">orig_size = </span><span class="p">(</span><span class="nx">orig_code</span><span class="p">.</span><span class="nx">length</span> <span class="err">/ 1024)</span>
  <span class="nv">jsp = </span><span class="nx">uglifyjs</span><span class="p">.</span><span class="nx">parser</span>
  <span class="nv">pro = </span><span class="nx">uglifyjs</span><span class="p">.</span><span class="nx">uglify</span>
  <span class="nv">ast = </span><span class="nx">jsp</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">orig_code</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>ast = pro.ast_mangle(ast)</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">ast = </span><span class="nx">pro</span><span class="p">.</span><span class="nx">ast_squeeze</span><span class="p">(</span><span class="nx">ast</span><span class="p">)</span>
  <span class="nv">minified = </span><span class="nx">pro</span><span class="p">.</span><span class="nx">gen_code</span><span class="p">(</span><span class="nx">ast</span><span class="p">)</span>
  <span class="nv">min_size = </span><span class="p">(</span><span class="nx">minified</span><span class="p">.</span><span class="nx">length</span> <span class="err">/ 1024)</span>
  <span class="nx">util</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;  Minified #{file_name} from #{formatKb(orig_size)} to #{formatKb(min_size)}&quot;</span><span class="p">)</span>
  <span class="nx">minified</span>
  </pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>When serving client files app.coffee or app.js must always be loaded first, so we're ensuring this here for now.
This is only temporary as big changes are coming to the way we serve and organise client files</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">exports.ensureCorrectOrder = </span><span class="nf">(files) -&gt;</span>
  <span class="nv">matches = </span><span class="nx">files</span><span class="p">.</span><span class="nx">filter</span> <span class="nf">(path) -&gt;</span>
    <span class="nv">file = </span><span class="nx">path</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">).</span><span class="nx">reverse</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nx">file</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;app&#39;</span>
  <span class="nv">first_file = </span><span class="nx">matches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
  <span class="k">if</span> <span class="nx">files</span><span class="p">.</span><span class="nx">include</span><span class="p">(</span><span class="nx">first_file</span><span class="p">)</span> 
    <span class="nv">files = </span><span class="nx">files</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="nx">first_file</span><span class="p">)</span>
    <span class="nx">files</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span><span class="nx">first_file</span><span class="p">)</span>
  <span class="nx">files</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 