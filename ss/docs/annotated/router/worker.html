<!DOCTYPE html>  <html> <head>   <title>worker.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="index.html">                 index.coffee               </a>                                           <a class="source" href="job_scheduler.html">                 job_scheduler.coffee               </a>                                           <a class="source" href="redis_proxy.html">                 redis_proxy.coffee               </a>                                           <a class="source" href="worker.html">                 worker.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               worker.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <h2>ZeroMQ Router Worker</h2>

<p>Launched by the 'socketstream router' process manager which will restart this process should it die.
The router performs the following functions:</p>

<ol>
<li>Brokers requests from multiple front end processes to multiple back end processes</li>
<li>Proxies broadcast/channel/user messages from Redis to front end servers (so Redis can live on a protected subnet)</li>
<li>Issues commands to be run on back end servers at regular intervals</li>
</ol>

<p>Note: the router automatically starts when you launch the integrated 'socketstream server'
For now there should only be one router worker process running in your cluster.
Ideally the the host running this will have dual NICs and hence act as a firewall.
As this is currently a single point of failure, the host running the router needs to be monitored carefully
We will work hard to reduce all single points of failure in the future. ZeroMQ/scaling experts please get in touch :)
Oh, and if you fancy writing this router in C or Erlang, please go ahead! We'd love to see the benchmarks :)</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Load Redis event proxy</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">proxy = </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./redis_proxy.coffee&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="nx">SS</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">redis</span><span class="p">.</span><span class="nx">enabled</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Load Job Scheduler</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">scheduler = </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./job_scheduler.coffee&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Counters</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">sent = </span><span class="mi">0</span>
<span class="nv">recv = </span><span class="mi">0</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Connect to sockets</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">frontend = </span><span class="nx">SS</span><span class="p">.</span><span class="nx">internal</span><span class="p">.</span><span class="nx">zmq</span><span class="p">.</span><span class="nx">createSocket</span><span class="p">(</span><span class="s1">&#39;xrep&#39;</span><span class="p">)</span>
<span class="nv">backend  = </span><span class="nx">SS</span><span class="p">.</span><span class="nx">internal</span><span class="p">.</span><span class="nx">zmq</span><span class="p">.</span><span class="nx">createSocket</span><span class="p">(</span><span class="s1">&#39;xreq&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Bind to ZeroMQ Sockets</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">frontend</span><span class="p">.</span><span class="nx">bindSync</span> <span class="nx">SS</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">cluster</span><span class="p">.</span><span class="nx">sockets</span><span class="p">.</span><span class="nx">fe_main</span>
<span class="nx">backend</span><span class="p">.</span><span class="nx">bindSync</span>  <span class="nx">SS</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">cluster</span><span class="p">.</span><span class="nx">sockets</span><span class="p">.</span><span class="nx">be_main</span>

<span class="nv">exports.init = </span><span class="nf">(args) -&gt;</span>
  <span class="nx">routeRequests</span><span class="p">()</span>
  <span class="nx">proxy</span> <span class="o">&amp;&amp;</span> <span class="nx">proxy</span><span class="p">.</span><span class="nx">init</span><span class="p">()</span>
  <span class="nx">scheduler</span><span class="p">.</span><span class="nx">run</span><span class="p">()</span>

  <span class="nx">showTraffic</span><span class="p">()</span> <span class="k">if</span> <span class="nx">args</span><span class="o">?</span><span class="p">[</span><span class="s1">&#39;--show-traffic&#39;</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Private</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">routeRequests = </span><span class="o">-&gt;</span>  
  <span class="nx">frontend</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="nf">(f_env, f_data) -&gt;</span>
    <span class="nx">backend</span><span class="p">.</span><span class="nx">send</span> <span class="nx">f_env</span><span class="p">,</span> <span class="nx">f_data</span>
    <span class="nx">recv</span><span class="o">++</span>
  
  <span class="nx">backend</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="nf">(b_env, b_data) -&gt;</span>
    <span class="nx">frontend</span><span class="p">.</span><span class="nx">send</span> <span class="nx">b_env</span><span class="p">,</span> <span class="nx">b_data</span>
    <span class="nx">sent</span><span class="o">++</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Print out basic status information. If you're seeing more INs than OUTs that's fine - some commands don't return a response</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">displayStatus = </span><span class="o">-&gt;</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;#{recv} REQ/CMDs IN - #{sent} RESPONSES OUT - #{proxy &amp;&amp; proxy.num_events_proxied || &#39;0&#39;} EVENTS PROXIED&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Show the status every 2 seconds</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">showTraffic = </span><span class="o">-&gt;</span>
  <span class="nx">setInterval</span> <span class="nx">displayStatus</span><span class="p">,</span> <span class="mi">2000</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 