<!DOCTYPE html>  <html> <head>   <title>redis_proxy.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="index.html">                 index.coffee               </a>                                           <a class="source" href="job_scheduler.html">                 job_scheduler.coffee               </a>                                           <a class="source" href="redis_proxy.html">                 redis_proxy.coffee               </a>                                           <a class="source" href="worker.html">                 worker.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               redis_proxy.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <h2>Redis Proxy</h2>

<p>Listens to incoming events from Redis and proxies them to front end server, either over ZeroMQ
or the internal EventEmitter</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Load Redis. Note these connections stay open so scripts will cease to terminate on their own once you call this</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">redis = </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../redis.coffee&#39;</span><span class="p">).</span><span class="nx">connect</span><span class="p">()</span>

<span class="nv">rpc = </span><span class="k">new</span> <span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../rpc/connection.coffee&#39;</span><span class="p">)).</span><span class="nx">Publisher</span>

<span class="nv">exports.num_events_proxied = </span><span class="mi">0</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>The router subscribes to Redis and simply forwards all incoming messages to all connected frontend servers (which in turn forwards them to the correct browsers via websockets)
Why do we do this? So Redis can sit securely behind the firewall and not be directly exposed to the Internet</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">exports.init = </span><span class="nf">(counter = 0) -&gt;</span>
  <span class="nv">key = </span><span class="nx">SS</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">redis</span><span class="p">.</span><span class="nx">key_prefix</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Subscribe to the following Redis channels
Note: User and channel messages are multiplexed over a single Redis channel. See http://groups.google.com/group/socketstream/browse_thread/thread/f7a8b3e932102d62 for more details</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="p">[</span><span class="s1">&#39;broadcast&#39;</span><span class="p">,</span> <span class="s1">&#39;users&#39;</span><span class="p">,</span> <span class="s1">&#39;channels&#39;</span><span class="p">,</span> <span class="s1">&#39;sockets&#39;</span><span class="p">].</span><span class="nx">forEach</span> <span class="nf">(channel) -&gt;</span>
    <span class="nx">redis</span><span class="p">.</span><span class="nx">pubsub</span><span class="p">.</span><span class="nx">subscribe</span> <span class="s2">&quot;#{key}:#{channel}&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Every time we get get a message from Redis (for SocketStream), fan out upstream to all subscribed frontend servers</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">redis</span><span class="p">.</span><span class="nx">pubsub</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="nf">(channel, message) -&gt;</span>
    <span class="p">[</span><span class="nx">prefix</span><span class="p">,</span> <span class="nx">msg_type</span><span class="p">]</span> <span class="o">=</span> <span class="nx">channel</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">prefix</span> <span class="o">&amp;&amp;</span> <span class="nx">prefix</span> <span class="o">==</span> <span class="nx">SS</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">redis</span><span class="p">.</span><span class="nx">key_prefix</span> <span class="o">&amp;&amp;</span> <span class="nx">message</span>
      <span class="nx">exports</span><span class="p">.</span><span class="nx">num_events_proxied</span><span class="o">++</span>
      <span class="nx">rpc</span><span class="p">.</span><span class="nx">send</span> <span class="nx">msg_type</span><span class="p">,</span> <span class="nx">message</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 