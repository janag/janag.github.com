<!DOCTYPE html>  <html> <head>   <title>server.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="api.html">                 api.coffee               </a>                                           <a class="source" href="benchmark.html">                 benchmark.coffee               </a>                                           <a class="source" href="benchmarks.html">                 benchmarks.coffee               </a>                                           <a class="source" href="browser_check.html">                 browser_check.coffee               </a>                                           <a class="source" href="check.html">                 check.coffee               </a>                                           <a class="source" href="client.html">                 client.coffee               </a>                                           <a class="source" href="compile.html">                 compile.coffee               </a>                                           <a class="source" href="connection.html">                 connection.coffee               </a>                                           <a class="source" href="copy.html">                 copy.coffee               </a>                                           <a class="source" href="default.html">                 default.coffee               </a>                                           <a class="source" href="generator.html">                 generator.coffee               </a>                                           <a class="source" href="http_redirect.html">                 http_redirect.coffee               </a>                                           <a class="source" href="https_redirect.html">                 https_redirect.coffee               </a>                                           <a class="source" href="index.html">                 index.coffee               </a>                                           <a class="source" href="internal.html">                 internal.coffee               </a>                                           <a class="source" href="job_scheduler.html">                 job_scheduler.coffee               </a>                                           <a class="source" href="loader.html">                 loader.coffee               </a>                                           <a class="source" href="logger.html">                 logger.coffee               </a>                                           <a class="source" href="main.html">                 main.coffee               </a>                                           <a class="source" href="manager.html">                 manager.coffee               </a>                                           <a class="source" href="mongoose.html">                 mongoose.coffee               </a>                                           <a class="source" href="pack.html">                 pack.coffee               </a>                                           <a class="source" href="parse_url.html">                 parse_url.coffee               </a>                                           <a class="source" href="plug_sockets.html">                 plug_sockets.coffee               </a>                                           <a class="source" href="publish.html">                 publish.coffee               </a>                                           <a class="source" href="rate_limiter.html">                 rate_limiter.coffee               </a>                                           <a class="source" href="redirect_to_root.html">                 redirect_to_root.coffee               </a>                                           <a class="source" href="redis.html">                 redis.coffee               </a>                                           <a class="source" href="redis_proxy.html">                 redis_proxy.coffee               </a>                                           <a class="source" href="rest.html">                 rest.coffee               </a>                                           <a class="source" href="rtm.html">                 rtm.coffee               </a>                                           <a class="source" href="serializer.html">                 serializer.coffee               </a>                                           <a class="source" href="server.html">                 server.coffee               </a>                                           <a class="source" href="session.html">                 session.coffee               </a>                                           <a class="source" href="socket.html">                 socket.coffee               </a>                                           <a class="source" href="socketstream.html">                 socketstream.coffee               </a>                                           <a class="source" href="ssl.html">                 ssl.coffee               </a>                                           <a class="source" href="subscribe.html">                 subscribe.coffee               </a>                                           <a class="source" href="system.html">                 system.coffee               </a>                                           <a class="source" href="templates.html">                 templates.coffee               </a>                                           <a class="source" href="users_online.html">                 users_online.coffee               </a>                                           <a class="source" href="utils.html">                 utils.coffee               </a>                                           <a class="source" href="worker.html">                 worker.coffee               </a>                                           <a class="source" href="wrapper.html">                 wrapper.coffee               </a>                                           <a class="source" href="zeromq.html">                 zeromq.coffee               </a>                                           <a class="source" href="zmq_async.html">                 zmq_async.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               server.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <h2>Request Handler for /app/server functions</h2>

<p>Used to handle incoming requests from the front end. Requests can either originate from Socket.IO or the HTTP API
Remember, the process action needs to be written with speed in mind as everything flows through it!</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">url_lib = </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;url&#39;</span><span class="p">)</span>
<span class="nv">utils = </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../../utils&#39;</span><span class="p">)</span>
<span class="nv">session = </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../session.coffee&#39;</span><span class="p">)</span>
<span class="nv">Session = </span><span class="nx">session</span><span class="p">.</span><span class="nx">Session</span>

<span class="nv">prefix = </span><span class="s1">&#39;/app/server&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Allow 'reserved variables' to be renamed (e.g. to match your local tongue)</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">var_session = </span><span class="nx">SS</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">reserved_vars</span><span class="p">.</span><span class="nx">session</span>
<span class="nv">var_request = </span><span class="nx">SS</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">reserved_vars</span><span class="p">.</span><span class="nx">request</span>
<span class="nv">var_user = </span>   <span class="nx">SS</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">reserved_vars</span><span class="p">.</span><span class="nx">user</span>
<span class="nx">var_socket_id</span><span class="o">=</span><span class="nx">SS</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">reserved_vars</span><span class="p">.</span><span class="nx">socket_id</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Make a list of variables you cannot use as action names (and warn below if you try)</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">reserved_variables = </span><span class="p">[</span><span class="s1">&#39;getSession&#39;</span><span class="p">,</span> <span class="nx">var_session</span><span class="p">,</span> <span class="nx">var_request</span><span class="p">,</span> <span class="nx">var_user</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Listen for calls to /app/server actions</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">SS</span><span class="p">.</span><span class="nx">backend</span><span class="p">.</span><span class="nx">responders</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;server&#39;</span><span class="p">,</span> <span class="nf">(obj, cb) -&gt;</span>
  <span class="k">try</span>
    <span class="nv">obj.session_obj = </span><span class="k">new</span> <span class="nx">Session</span><span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">session</span><span class="p">)</span>
    <span class="nx">process</span> <span class="nx">obj</span><span class="p">,</span> <span class="nf">(result) -&gt;</span>
      <span class="nx">SS</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">outgoing</span><span class="p">.</span><span class="nx">server</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span>
      <span class="nx">cb</span> <span class="p">{</span><span class="nv">id: </span><span class="nx">obj</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nv">result: </span><span class="nx">result</span><span class="p">,</span> <span class="nv">session_updates: </span><span class="nx">session</span><span class="p">.</span><span class="nx">updates</span><span class="p">.</span><span class="nx">purge</span><span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">session_obj</span><span class="p">.</span><span class="nx">id</span><span class="p">)}</span>
  <span class="k">catch</span> <span class="nx">e</span>
    <span class="nx">SS</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">exception</span><span class="p">(</span><span class="s1">&#39;Error: &#39;</span> <span class="o">+</span> <span class="nx">e</span><span class="p">.</span><span class="nx">message</span><span class="p">)</span> <span class="k">if</span> <span class="nx">e</span><span class="p">.</span><span class="nx">message</span>
    <span class="nx">cb</span> <span class="p">{</span><span class="nv">id: </span><span class="nx">obj</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nv">error: </span><span class="nx">e</span><span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Private</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">process = </span><span class="nf">(obj, cb) -&gt;</span>

  <span class="nv">action_array = </span><span class="nx">obj</span><span class="p">.</span><span class="nx">method</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>

  <span class="k">throw</span> <span class="nx">error</span><span class="p">(</span><span class="s1">&#39;INVALID_ACTION_FORMAT&#39;</span><span class="p">,</span> <span class="s2">&quot;Invalid action format&quot;</span><span class="p">)</span> <span class="nx">unless</span> <span class="k">typeof</span><span class="p">(</span><span class="nx">action_array</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;object&#39;</span>
  <span class="k">throw</span> <span class="nx">error</span><span class="p">(</span><span class="s1">&#39;INVALID_ACTION_LENGTH&#39;</span><span class="p">,</span> <span class="s2">&quot;Invalid action length&quot;</span><span class="p">)</span> <span class="nx">unless</span> <span class="nx">action_array</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;=</span> <span class="mi">2</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Create a copy before we mangle it</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">actions = </span><span class="nx">action_array</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
  <span class="nv">action = </span><span class="nx">actions</span><span class="p">.</span><span class="nx">pop</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Make sure action name isn't reserved</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">throw</span> <span class="nx">error</span><span class="p">(</span><span class="s1">&#39;RESERVED_WORD&#39;</span><span class="p">,</span> <span class="s2">&quot;Unable to call the &#39;#{action}&#39; action as this is a special reserved word. Please rename this action or specify different reserved variables names with SS.config.reserved_vars&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="nx">action</span> <span class="k">in</span> <span class="nx">reserved_variables</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Load the module from the SS.server tree (which is only loaded once)</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">server_module = </span><span class="nx">utils</span><span class="p">.</span><span class="nx">getFromTree</span><span class="p">(</span><span class="nx">SS</span><span class="p">.</span><span class="nx">server</span><span class="p">,</span> <span class="nx">actions</span><span class="p">)</span>
  </pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Check module exists before we attempt to call a function on it</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">throw</span> <span class="nx">error</span><span class="p">(</span><span class="s1">&#39;MODULE_NOT_FOUND&#39;</span><span class="p">,</span> <span class="s2">&quot;Unable to find the #{prefix}/#{actions.join(&#39;/&#39;)} module. Does the file exist?&quot;</span><span class="p">)</span> <span class="nx">unless</span> <span class="nx">server_module</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Check to see if the action exists within the file</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">method = </span><span class="nx">server_module</span><span class="p">[</span><span class="nx">action</span><span class="p">]</span>
  <span class="k">throw</span> <span class="nx">error</span><span class="p">(</span><span class="s1">&#39;ACTION_NOT_FOUND&#39;</span><span class="p">,</span> <span class="s2">&quot;Unable to find the &#39;#{action}&#39; action in #{prefix}/#{actions.join(&#39;/&#39;)}. Action names are case sensitive&quot;</span><span class="p">)</span> <span class="nx">unless</span> <span class="nx">method</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Build up args to pass to server action</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">args = </span><span class="nx">obj</span><span class="p">.</span><span class="nx">params</span> <span class="o">||</span> <span class="p">[]</span>
  <span class="nx">args</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">cb</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Check we have have the correct number of params</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">throw</span> <span class="nx">error</span><span class="p">(</span><span class="s1">&#39;MISSING_CALLBACK&#39;</span><span class="p">,</span>   <span class="s2">&quot;The #{action} action is unable to take a callback as the last argument&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="nx">method</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span>
  <span class="k">throw</span> <span class="nx">error</span><span class="p">(</span><span class="s1">&#39;MISSING_ARGS&#39;</span><span class="p">,</span>       <span class="s2">&quot;The #{action} action expects #{(method.length - 1).pluralize(&#39;argument&#39;)} (plus a callback) but #{if (a = args.length - 1) &gt; 0 then &#39;only &#39; + a else &#39;none&#39;} #{if args.length == 2 then &#39;was&#39; else &#39;were&#39;} sent&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="nx">method</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="nx">args</span><span class="p">.</span><span class="nx">length</span>
  <span class="k">throw</span> <span class="nx">error</span><span class="p">(</span><span class="s1">&#39;TOO_MANY_ARGS&#39;</span><span class="p">,</span>      <span class="s2">&quot;The #{action} action was sent #{(args.length - 1).pluralize(&#39;argument&#39;)} (plus a callback) but can only receive #{method.length - 1}&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="nx">method</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="nx">args</span><span class="p">.</span><span class="nx">length</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Create the @request object</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">server_module</span><span class="p">[</span><span class="nx">var_request</span><span class="p">]</span> <span class="o">=</span> <span class="nv">request = </span><span class="p">{</span><span class="nv">id: </span><span class="nx">obj</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nv">socket_id: </span><span class="nx">obj</span><span class="p">.</span><span class="nx">socket_id</span><span class="p">}</span>
  <span class="nv">request.origin = </span><span class="nx">obj</span><span class="p">.</span><span class="nx">origin</span>     <span class="k">if</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">origin</span>
  <span class="nv">request.post = </span><span class="nx">post</span><span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">post</span><span class="p">)</span>   <span class="k">if</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">post</span>
 </pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Create @session object if we have a session_id</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">server_module</span><span class="p">[</span><span class="nx">var_session</span><span class="p">]</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">session_obj</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Keep in for compatibility until 0.3</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">server_module.getSession = </span><span class="nf">(scb) -&gt;</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s1">&#39;Warning: @getSession will be removed in 0.3. Please use the @session variable&#39;</span>
    <span class="nx">scb</span> <span class="nx">server_module</span><span class="p">[</span><span class="nx">var_session</span><span class="p">]</span>
  </pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Make sure we have a valid user_id</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">throw</span> <span class="nx">error</span><span class="p">(</span><span class="s1">&#39;UNAUTHORIZED&#39;</span><span class="p">,</span> <span class="s2">&quot;This session has not been authenticated&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="nx">SS</span><span class="p">.</span><span class="nx">internal</span><span class="p">.</span><span class="nx">authenticate</span><span class="p">[</span><span class="nx">actions</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)]</span> <span class="o">and</span> <span class="o">!</span><span class="nx">server_module</span><span class="p">[</span><span class="nx">var_session</span><span class="p">].</span><span class="nx">user</span><span class="p">.</span><span class="nx">loggedIn</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Execute action  </p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">try</span>
    <span class="nx">method</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">server_module</span><span class="p">,</span> <span class="nx">args</span><span class="p">)</span>
  <span class="k">catch</span> <span class="nx">e</span>
    <span class="nx">SS</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">emit</span> <span class="s1">&#39;application:exception&#39;</span><span class="p">,</span> <span class="nx">e</span>
    <span class="k">throw</span> <span class="nx">error</span><span class="p">(</span><span class="s1">&#39;APPLICATION_ERROR&#39;</span><span class="p">,</span> <span class="nx">e</span><span class="p">.</span><span class="nx">stack</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Return an object containing post data
Will be expanded in the future to allow @request.post.params and @request.post.file.saveTo('/tmp/myfile.jpg') etc</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">post = </span><span class="nf">(raw_data) -&gt;</span>
  <span class="p">{</span><span class="nv">raw: </span><span class="nx">raw_data</span><span class="p">}</span>

<span class="nv">error = </span><span class="nf">(code, message) -&gt;</span>
  <span class="p">{</span><span class="nv">code: </span><span class="nx">code</span><span class="p">,</span> <span class="nv">message: </span><span class="nx">message</span><span class="p">}</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 