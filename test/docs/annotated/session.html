<!DOCTYPE html>  <html> <head>   <title>session.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="api.html">                 api.coffee               </a>                                           <a class="source" href="benchmark.html">                 benchmark.coffee               </a>                                           <a class="source" href="benchmarks.html">                 benchmarks.coffee               </a>                                           <a class="source" href="browser_check.html">                 browser_check.coffee               </a>                                           <a class="source" href="check.html">                 check.coffee               </a>                                           <a class="source" href="client.html">                 client.coffee               </a>                                           <a class="source" href="compile.html">                 compile.coffee               </a>                                           <a class="source" href="connection.html">                 connection.coffee               </a>                                           <a class="source" href="copy.html">                 copy.coffee               </a>                                           <a class="source" href="default.html">                 default.coffee               </a>                                           <a class="source" href="generator.html">                 generator.coffee               </a>                                           <a class="source" href="http_redirect.html">                 http_redirect.coffee               </a>                                           <a class="source" href="https_redirect.html">                 https_redirect.coffee               </a>                                           <a class="source" href="index.html">                 index.coffee               </a>                                           <a class="source" href="internal.html">                 internal.coffee               </a>                                           <a class="source" href="job_scheduler.html">                 job_scheduler.coffee               </a>                                           <a class="source" href="loader.html">                 loader.coffee               </a>                                           <a class="source" href="logger.html">                 logger.coffee               </a>                                           <a class="source" href="main.html">                 main.coffee               </a>                                           <a class="source" href="manager.html">                 manager.coffee               </a>                                           <a class="source" href="mongoose.html">                 mongoose.coffee               </a>                                           <a class="source" href="pack.html">                 pack.coffee               </a>                                           <a class="source" href="parse_url.html">                 parse_url.coffee               </a>                                           <a class="source" href="plug_sockets.html">                 plug_sockets.coffee               </a>                                           <a class="source" href="publish.html">                 publish.coffee               </a>                                           <a class="source" href="rate_limiter.html">                 rate_limiter.coffee               </a>                                           <a class="source" href="redis.html">                 redis.coffee               </a>                                           <a class="source" href="redis_proxy.html">                 redis_proxy.coffee               </a>                                           <a class="source" href="rest.html">                 rest.coffee               </a>                                           <a class="source" href="rtm.html">                 rtm.coffee               </a>                                           <a class="source" href="serializer.html">                 serializer.coffee               </a>                                           <a class="source" href="server.html">                 server.coffee               </a>                                           <a class="source" href="session.html">                 session.coffee               </a>                                           <a class="source" href="socket.html">                 socket.coffee               </a>                                           <a class="source" href="socketstream.html">                 socketstream.coffee               </a>                                           <a class="source" href="ssl.html">                 ssl.coffee               </a>                                           <a class="source" href="subscribe.html">                 subscribe.coffee               </a>                                           <a class="source" href="system.html">                 system.coffee               </a>                                           <a class="source" href="templates.html">                 templates.coffee               </a>                                           <a class="source" href="users_online.html">                 users_online.coffee               </a>                                           <a class="source" href="utils.html">                 utils.coffee               </a>                                           <a class="source" href="worker.html">                 worker.coffee               </a>                                           <a class="source" href="wrapper.html">                 wrapper.coffee               </a>                                           <a class="source" href="zeromq.html">                 zeromq.coffee               </a>                                           <a class="source" href="zmq_async.html">                 zmq_async.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               session.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <h2>Session</h2>

<p>Creates and maintains a persistent session once a visitor connects over websockets
Session data is also synched / cached on the front end server the client is connected to and sent along with every RPC request to avoid callbacks and constantly hammering the session store (e.g. Redis)
The goal here is to ensure pressing refresh on the page, accidentally or otherwise, keeps you in the same session - regardless of which front server you connect to</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">EventEmitter = </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;events&#39;</span><span class="p">).</span><span class="nx">EventEmitter</span>
<span class="nv">util = </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;util&#39;</span><span class="p">)</span>
<span class="nv">utils = </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./../utils&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Store session information internally if Redis is not present
Note internal store is for development/experimentation only, not production use</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">store_name = </span><span class="nx">SS</span><span class="p">.</span><span class="nx">redis</span> <span class="o">&amp;&amp;</span> <span class="s1">&#39;redis&#39;</span> <span class="o">||</span> <span class="s1">&#39;internal&#39;</span>
<span class="nv">store = </span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;./session_storage/#{store_name}.coffee&quot;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Set constants</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">fields_to_store = </span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">,</span><span class="s1">&#39;user_id&#39;</span><span class="p">,</span><span class="s1">&#39;channels&#39;</span><span class="p">,</span><span class="s1">&#39;attributes&#39;</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <h2>Session Class</h2>

<p>A new instance of Session is created each time a websocket client connects or an API request is received
Sessions created when using the API are not saved (at the moment)</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">exports</span><span class="p">.</span><span class="nx">Session</span> <span class="k">extends</span> <span class="nx">EventEmitter</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Note: A unique @id will only be passed if the request originates over websockets</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">constructor: </span><span class="nf">(data = {}) -&gt;</span>
    <span class="vi">@attributes = </span><span class="p">{}</span>            <span class="c1"># store a hash of custom session data. e.g. {items_in_cart: 3}</span>
    <span class="vi">@user_id = </span><span class="kc">null</span>             <span class="c1"># sessions start off unauthenticated by default</span>
    <span class="vi">@channels = </span><span class="p">[]</span>              <span class="c1"># records pub/sub private channels the session is subscribed to</span>
    <span class="nx">@init</span><span class="p">()</span>                     <span class="c1"># passes this session instance to nested objects</span>
    </pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Copy existing data into this instance</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">fields_to_store</span><span class="p">.</span><span class="nx">forEach</span> <span class="p">(</span><span class="nx">field</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="k">if</span> <span class="nx">data</span><span class="p">[</span><span class="nx">field</span><span class="p">]</span><span class="o">?</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>as we're going to be looking for differences we can't copy arrays, must clone</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="err">@</span><span class="p">[</span><span class="nx">field</span><span class="p">]</span> <span class="o">=</span> <span class="k">if</span> <span class="err">@</span><span class="p">[</span><span class="nx">field</span><span class="p">]</span><span class="o">?</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span><span class="p">(</span><span class="err">@</span><span class="p">[</span><span class="nx">field</span><span class="p">])</span> <span class="o">==</span> <span class="s1">&#39;object&#39;</span> <span class="o">&amp;&amp;</span> <span class="err">@</span><span class="p">[</span><span class="nx">field</span><span class="p">].</span><span class="nx">length</span> <span class="o">!=</span> <span class="kc">undefined</span>
          <span class="nx">data</span><span class="p">[</span><span class="nx">field</span><span class="p">].</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span>
          <span class="nx">data</span><span class="p">[</span><span class="nx">field</span><span class="p">]</span>
    </pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Return instance</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="err">@</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <h3>Methods beginning _ should only be used internally</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Load an existing session or store a new one</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">_findOrCreate: </span><span class="nf">(cb) -&gt;</span>
    <span class="k">if</span> <span class="nx">isValidId</span><span class="p">(</span><span class="nx">@id</span><span class="p">)</span>
      <span class="nx">store</span><span class="p">.</span><span class="nx">getAll</span> <span class="nx">@id</span><span class="p">,</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="k">if</span> <span class="o">!</span><span class="nx">data</span> <span class="o">or</span> <span class="o">!</span><span class="nx">data</span><span class="p">.</span><span class="nx">created_at</span>
          <span class="nx">cb</span> <span class="nx">@_createNew</span><span class="p">()</span>             <span class="c1"># session doesn&#39;t exist or is invalid</span>
        <span class="k">else</span>
          <span class="nx">cb</span> <span class="nx">@_fromExisting</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>      <span class="c1"># session exists so pass through attributes</span>
    <span class="k">else</span>
      <span class="nx">cb</span> <span class="nx">@_createNew</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Data this session needs to store. Doing it this way to reduce bytes we're storing on the front end and passing over the wire</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">_data: </span><span class="o">-&gt;</span>
    <span class="nv">out = </span><span class="p">{</span><span class="nv">id: </span><span class="nx">@id</span><span class="p">}</span>
    <span class="nx">@user_id</span>          <span class="o">&amp;&amp;</span> <span class="nv">out.user_id = </span><span class="nx">@user_id</span>
    <span class="nx">@channels</span><span class="p">.</span><span class="nx">any</span><span class="p">()</span>   <span class="o">&amp;&amp;</span> <span class="nv">out.channels = </span><span class="nx">@channels</span>
    <span class="nx">@attributes</span><span class="p">.</span><span class="nx">any</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="nv">out.attributes = </span><span class="nx">@attributes</span>
    <span class="nx">out</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Output only the differences between the original and current session values
The deltas are sent back to the front end server so the socket.ss.session object can be updated</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">_updates: </span><span class="nf">(original) -&gt;</span>
    <span class="nv">updated = </span><span class="kc">false</span>
    <span class="nv">out = </span><span class="p">{}</span>
    <span class="nx">fields_to_store</span><span class="p">.</span><span class="nx">forEach</span> <span class="p">(</span><span class="nx">field</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="k">if</span> <span class="nx">original</span><span class="p">[</span><span class="nx">field</span><span class="p">]</span> <span class="o">!=</span> <span class="err">@</span><span class="p">[</span><span class="nx">field</span><span class="p">]</span>
        <span class="nv">updated = </span><span class="kc">true</span>
        <span class="nx">out</span><span class="p">[</span><span class="nx">field</span><span class="p">]</span> <span class="o">=</span> <span class="err">@</span><span class="p">[</span><span class="nx">field</span><span class="p">]</span> 
    <span class="nx">updated</span> <span class="o">&amp;&amp;</span> <span class="nx">out</span> <span class="o">||</span> <span class="kc">undefined</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Load session data from the store</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">_fromExisting: </span><span class="nf">(data) -&gt;</span>
    <span class="vi">@newly_created = </span><span class="kc">false</span>
    <span class="vi">@created_at = </span><span class="nx">data</span><span class="p">.</span><span class="nx">created_at</span>
    <span class="vi">@user_id = </span><span class="nx">data</span><span class="p">.</span><span class="nx">user_id</span>
    <span class="vi">@attributes = </span><span class="nx">data</span><span class="p">.</span><span class="nx">attributes</span> <span class="o">||</span> <span class="p">{}</span>
    <span class="vi">@channels = </span><span class="nx">data</span><span class="p">.</span><span class="nx">channels</span> <span class="o">||</span> <span class="p">[]</span>
    <span class="err">@</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Create a brand new session</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">_createNew: </span><span class="o">-&gt;</span>
    <span class="vi">@newly_created = </span><span class="kc">true</span>
    <span class="vi">@created_at = </span><span class="nb">Number</span><span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">())</span>
    <span class="nx">store</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">@id</span><span class="p">,</span> <span class="s1">&#39;created_at&#39;</span><span class="p">,</span> <span class="nx">@created_at</span><span class="p">)</span> <span class="k">if</span> <span class="nx">@id</span> <span class="c1"># only save if this is a persistent (none-API) connection</span>
    <span class="err">@</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <h3>Public methods</h3>             </td>             <td class="code">               <div class="highlight"><pre>  </pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>This method is called both by the constructor and each time an incoming websocket call is processed
It enables the nested namespaces ('user' and 'group') to access the current session object instead of the last one initialized by the constructor
For now this seems to be the best way to allow namespacing without storing separate copies the objects for each Session
Hopefully we will find a nicer way to do this in the future!</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">init: </span><span class="o">-&gt;</span>
    <span class="nx">@user</span><span class="p">.</span><span class="nx">_init</span><span class="p">(</span><span class="err">@</span><span class="p">)</span>
    <span class="nx">@channel</span><span class="p">.</span><span class="nx">_init</span><span class="p">(</span><span class="err">@</span><span class="p">)</span>
  </pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Save Attributes</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">save: </span><span class="nf">(cb = -&gt;) -&gt;</span>
    <span class="k">return</span> <span class="nx">cb</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span> <span class="nx">unless</span> <span class="nx">@id</span>
    <span class="nx">store</span><span class="p">.</span><span class="nx">set</span> <span class="nx">@id</span><span class="p">,</span> <span class="s1">&#39;attributes&#39;</span><span class="p">,</span> <span class="nx">@attributes</span><span class="p">,</span> <span class="nx">cb</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Authentication. See README file for full details and examples</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">authenticate: </span><span class="nf">(module_name, params, cb) -&gt;</span>
    <span class="nv">klass = </span><span class="nx">require</span><span class="p">(</span><span class="nx">module_name</span><span class="p">)</span>
    <span class="nx">klass</span><span class="p">.</span><span class="nx">authenticate</span> <span class="nx">params</span><span class="p">,</span> <span class="nx">cb</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Will promote the session to an Authenticated Session for the given User ID. Use after successful authentication</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">setUserId: </span><span class="nf">(user_id, cb = -&gt;) -&gt;</span>
    <span class="k">return</span> <span class="kc">false</span> <span class="nx">unless</span> <span class="nx">user_id</span>
    <span class="vi">@user_id = </span><span class="nx">user_id</span>
    <span class="k">if</span> <span class="nx">@id</span>
      <span class="nx">SS</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="nx">online</span> <span class="o">&amp;&amp;</span> <span class="nx">SS</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="nx">online</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">@user_id</span><span class="p">)</span>
      <span class="nx">store</span><span class="p">.</span><span class="nx">set</span> <span class="nx">@id</span><span class="p">,</span> <span class="s1">&#39;user_id&#39;</span><span class="p">,</span> <span class="nx">@user_id</span><span class="p">,</span> <span class="nx">cb</span>
    </pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Authenticated Users</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">user:</span>
  
    <span class="nv">_init: </span><span class="nf">(@session) -&gt;</span>
    
    <span class="nv">key: </span><span class="o">-&gt;</span>
      <span class="s2">&quot;#{key}:user:#{@session.user_id}&quot;</span>
    
    <span class="nv">loggedIn: </span><span class="o">-&gt;</span>
      <span class="nx">@session</span><span class="p">.</span><span class="nx">user_id</span><span class="o">?</span>
      
    <span class="nv">logout: </span><span class="nf">(cb = -&gt;) -&gt;</span>
      <span class="nx">SS</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="nx">online</span> <span class="o">&amp;&amp;</span> <span class="nx">SS</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="nx">online</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">@session</span><span class="p">.</span><span class="nx">user_id</span><span class="p">)</span>
      <span class="nx">store</span><span class="p">.</span><span class="nx">set</span> <span class="nx">@session</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="s1">&#39;previous_user_id&#39;</span><span class="p">,</span> <span class="nx">@session</span><span class="p">.</span><span class="nx">user_id</span> <span class="c1"># for retrospective log analysis</span>
      <span class="vi">@session.user_id = </span><span class="kc">null</span>
      <span class="nx">store</span><span class="p">.</span><span class="k">delete</span> <span class="nx">@session</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="s1">&#39;user_id&#39;</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="nx">cb</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Pub/Sub Private Channels</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">channel:</span>
  
    <span class="nv">_init: </span><span class="nf">(@session) -&gt;</span>
  </pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>Lists all the channels the client is currently subscribed to</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">list: </span><span class="o">-&gt;</span>
      <span class="nx">@session</span><span class="p">.</span><span class="nx">channels</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>Subscribes the client to one or more channels</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">subscribe: </span><span class="nf">(names, cb = -&gt;) -&gt;</span>
      <span class="nx">forceArray</span><span class="p">(</span><span class="nx">names</span><span class="p">).</span><span class="nx">forEach</span> <span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="nx">unless</span> <span class="nx">@session</span><span class="p">.</span><span class="nx">channels</span><span class="p">.</span><span class="nx">include</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="c1"># clients can only join a channel once</span>
          <span class="nx">@session</span><span class="p">.</span><span class="nx">channels</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span>
          <span class="nx">SS</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">pubsub</span><span class="p">.</span><span class="nx">channels</span><span class="p">.</span><span class="nx">subscribe</span> <span class="nx">@session</span><span class="p">.</span><span class="nx">user_id</span><span class="p">,</span> <span class="nx">name</span>
          <span class="nx">SS</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">emit</span> <span class="s1">&#39;channel:subscribe&#39;</span><span class="p">,</span> <span class="nx">@session</span><span class="p">,</span> <span class="nx">name</span>
      <span class="nx">@_save</span> <span class="nx">cb</span>
     </pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>Unsubscribes the client from one or more channels</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">unsubscribe: </span><span class="nf">(names, cb = -&gt;) -&gt;</span>
      <span class="nx">forceArray</span><span class="p">(</span><span class="nx">names</span><span class="p">).</span><span class="nx">forEach</span> <span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="k">if</span> <span class="nx">@session</span><span class="p">.</span><span class="nx">channels</span><span class="p">.</span><span class="nx">include</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span>
          <span class="vi">@session.channels = </span><span class="nx">@session</span><span class="p">.</span><span class="nx">channels</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span>
          <span class="nx">SS</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">pubsub</span><span class="p">.</span><span class="nx">channels</span><span class="p">.</span><span class="nx">unsubscribe</span><span class="p">(</span><span class="nx">@session</span><span class="p">.</span><span class="nx">user_id</span><span class="p">,</span> <span class="nx">name</span><span class="p">)</span>
          <span class="nx">SS</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">emit</span> <span class="s1">&#39;channel:unsubscribe&#39;</span><span class="p">,</span> <span class="nx">@session</span><span class="p">,</span> <span class="nx">name</span>
      <span class="nx">@_save</span> <span class="nx">cb</span>
    </pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>Unsubscribes the client from all channels</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">unsubscribeAll: </span><span class="nf">(cb = -&gt;) -&gt;</span>
      <span class="nx">@unsubscribe</span> <span class="nx">@list</span><span class="p">(),</span> <span class="nx">cb</span>
    </pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>Stores channel subscriptions so they can be re-invoked if the page is reloaded</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">_save: </span><span class="nf">(cb) -&gt;</span>
      <span class="nx">store</span><span class="p">.</span><span class="nx">set</span> <span class="nx">@session</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="s1">&#39;channels&#39;</span><span class="p">,</span> <span class="nx">@session</span><span class="p">.</span><span class="nx">channels</span><span class="p">,</span> <span class="nx">cb</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>PRIVATE HELPERS</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">isValidId = </span><span class="nf">(session_id) -&gt;</span>
  <span class="nx">session_id</span> <span class="o">and</span> <span class="nx">session_id</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">32</span>

<span class="nv">forceArray = </span><span class="nf">(input) -&gt;</span>
  <span class="k">typeof</span><span class="p">(</span><span class="nx">input</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;object&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">input</span> <span class="o">||</span> <span class="p">[</span><span class="nx">input</span><span class="p">]</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 